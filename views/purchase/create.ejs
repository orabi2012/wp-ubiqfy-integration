<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title || 'Purchase Order' %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <link href="/css/purchase-order-create.css" rel="stylesheet">
    <link href="/css/purchases.css" rel="stylesheet">

    <!-- Page Data - Clean JSON approach -->
    <script type="application/json" id="page-data">
        {
            "storeId": "<%= storeId || '' %>",
            "userId": "<%= userId || '' %>", 
            "orderId": "<%= orderId || '' %>",
            <% if (typeof existingOrder !== 'undefined' && existingOrder) { %>
            "existingOrder": {
                "id": "<%= existingOrder.id || '' %>",
                "purchase_order_number": "<%= existingOrder.purchase_order_number || '' %>",
                "status": "<%= existingOrder.status || 'DRAFT' %>",
                "total_wholesale_cost": <%= existingOrder.total_wholesale_cost || 0 %>,
                "currency": "<%= existingOrder.currency || 'USD' %>",
                "created_at": "<%= existingOrder.created_at || '' %>",
                "items": [
                    <% if (existingOrder.purchaseItems && existingOrder.purchaseItems.length > 0) { %>
                        <% existingOrder.purchaseItems.forEach((item, index) => { %>
                            {
                                "id": "<%= item.id || '' %>",
                                "product_type_code": "<%= item.product_type_code || '' %>",
                                "product_code": "<%= item.product_code || '' %>",
                                "provider_code": "<%= item.provider_code || '' %>",
                                "product_option_code": "<%= item.product_option_code || '' %>",
                                "product_name": "<%= (item.product_name || 'Unknown').replace(/"/g, '\\"') %>",
                                "product_option_name": "<%= (item.product_option_name || '').replace(/"/g, '\\"') %>",
                                "quantity_ordered": <%= item.quantity_ordered || 0 %>,
                                "unit_face_value": <%= item.unit_face_value || 0 %>,
                                "unit_wholesale_price": <%= item.unit_wholesale_price || 0 %>,
                                "total_wholesale_cost": <%= item.total_wholesale_cost || 0 %>
                            }<%= index < existingOrder.purchaseItems.length - 1 ? ',' : '' %>
                        <% }); %>
                    <% } %>
                ]
            }
            <% } else { %>
            "existingOrder": null
            <% } %>
        }
    </script>
</head>

<body>
    <% const pageTitle=(typeof existingOrder !=='undefined' && existingOrder) ? "Edit Purchase Order"
        : "Create Purchase Order" %>
        <%- include('../shared/navbar') %>

            <div class="container mt-4 purchase-order-container">
                <!-- Header Section -->

                <div class="container mt-4 purchase-order-container">
                    <!-- Invoice Header -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="purchase-order-header">
                                <h2 class="purchase-order-title">Purchase Order</h2>
                                <% if (typeof existingOrder !=='undefined' && existingOrder) { %>
                                    <h4 class="order-number">#<%= existingOrder.purchase_order_number ||
                                            existingOrder.id.substring(0, 8) %>
                                    </h4>
                                    <% } else { %>
                                        <h4 class="order-number">New Purchase Order</h4>
                                        <% } %>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <% if (typeof existingOrder !=='undefined' && existingOrder) { %>
                                <span
                                    class="badge bg-<%= existingOrder.status === 'COMPLETED' ? 'success' : existingOrder.status === 'PROCESSING' ? 'info' : existingOrder.status === 'PENDING' ? 'warning' : 'secondary' %> status-badge fs-6 p-2">
                                    <%= existingOrder.status %>
                                </span>

                                <!-- Show voucher counts for completed orders -->
                                <% if (existingOrder.status==='COMPLETED' && existingOrder.voucherDetails &&
                                    existingOrder.voucherDetails.length> 0) { %>
                                    <div class="mt-2">
                                        <small class="d-block">
                                            <span class="text-success fw-bold">
                                                <%= existingOrder.voucherDetails.filter(d=> d.operation_succeeded ===
                                                    true).length
                                                    %>
                                            </span>
                                            successful,
                                            <span class="text-danger fw-bold">
                                                <%= existingOrder.voucherDetails.filter(d=> d.operation_succeeded ===
                                                    false).length
                                                    %>
                                            </span>
                                            failed of <%= existingOrder.voucherDetails.length %> total
                                        </small>
                                    </div>
                                    <% } %>

                                        <div class="mt-2 text-muted">
                                            Created: <%= new Date(existingOrder.created_at).toLocaleDateString() %>
                                        </div>
                                        <% } %>
                        </div>

                        <!-- Purchase Items Table (Invoice Style) -->
                        <div class="card purchase-create-card mb-4 items-card">
                            <div class="card-header items-card-header">
                                <h5>Items</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped items-table">
                                        <thead>
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="40%">Product</th>
                                                <th width="15%">Quantity</th>
                                                <th width="15%">Unit Price</th>
                                                <th width="15%">Total</th>
                                                <th width="10%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-table-body">
                                            <tr>
                                                <td colspan="6" class="empty-state">No items added yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Voucher Processing Details (for completed orders) -->
                        <% if (typeof existingOrder !=='undefined' && existingOrder &&
                            existingOrder.status==='COMPLETED' && existingOrder.voucherDetails &&
                            existingOrder.voucherDetails.length> 0) { %>
                            <div class="card purchase-create-card mb-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-check-circle me-2 text-success"></i>Successful Voucher
                                        Processing
                                        Results
                                    </h5>
                                    <small class="text-muted">Showing only successfully processed vouchers</small>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th width="15%">Voucher Code</th>
                                                    <th width="15%">Status</th>
                                                    <th width="15%">Amount</th>
                                                    <th width="20%">Provider Response</th>
                                                    <th width="15%">Processing Time</th>
                                                    <th width="20%">Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% const successfulVouchers=existingOrder.voucherDetails.filter(detail=>
                                                    detail.operation_succeeded === true);
                                                    let successIndex = 0;
                                                    %>
                                                    <% if (successfulVouchers.length===0) { %>
                                                        <tr>
                                                            <td colspan="6" class="text-center text-muted">No successful
                                                                voucher
                                                                processing found</td>
                                                        </tr>
                                                        <% } else { %>
                                                            <% successfulVouchers.forEach((detail)=> { %>
                                                                <% successIndex++; %>
                                                                    <tr class="table-success">
                                                                        <td>
                                                                            <small class="fw-bold">
                                                                                <%= detail.voucher_code || `Voucher
                                                                                    #${successIndex}` %>
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <span class="badge bg-success">
                                                                                <i class="fas fa-check me-1"></i>Success
                                                                            </span>
                                                                        </td>
                                                                        <td>
                                                                            <small class="fw-bold">
                                                                                $<%= (parseFloat(detail.amount_wholesale)
                                                                                    || 0).toFixed(2) %>
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <small class="text-muted">
                                                                                <%= detail.provider_response
                                                                                    || 'No response' %>
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <small class="text-muted">
                                                                                <% if (detail.processed_at) { %>
                                                                                    <%= new
                                                                                        Date(detail.processed_at).toLocaleString()
                                                                                        %>
                                                                                        <% } else { %>
                                                                                            Not processed
                                                                                            <% } %>
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <small class="text-success">
                                                                                Processing completed successfully
                                                                            </small>
                                                                        </td>
                                                                    </tr>
                                                                    <% }); %>
                                                                        <% } %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Summary Statistics -->
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <div class="h4 text-success mb-1">
                                                        <%= existingOrder.voucherDetails.filter(d=>
                                                            d.operation_succeeded ===
                                                            true).length %>
                                                    </div>
                                                    <small class="text-muted">Successful</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <div class="h4 text-danger mb-1">
                                                        <%= existingOrder.voucherDetails.filter(d=>
                                                            d.operation_succeeded ===
                                                            false).length %>
                                                    </div>
                                                    <small class="text-muted">Failed</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <div class="h4 text-primary mb-1">
                                                        <%= existingOrder.voucherDetails.length %>
                                                    </div>
                                                    <small class="text-muted">Total Vouchers</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <% const successfulAmount=existingOrder.voucherDetails .filter(d=>
                                                        d.operation_succeeded === true)
                                                        .reduce((sum, d) => sum + (parseFloat(d.amount_wholesale) || 0),
                                                        0);
                                                        %>
                                                        <div class="h4 text-success mb-1">
                                                            $<%= successfulAmount.toFixed(2) %>
                                                        </div>
                                                        <small class="text-muted">Successful Amount</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                                <!-- Invoice Footer -->
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-body">
                                                <% if (typeof existingOrder !=='undefined' && existingOrder) { %>
                                                    <% if (['completed', 'failed' , 'cancelled' , 'processing'
                                                        ].includes(existingOrder.status.toLowerCase())) { %>
                                                        <!-- Read-only mode for non-editable orders -->
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            <strong>Order Status: <%= existingOrder.status.toUpperCase()
                                                                    %>
                                                            </strong>
                                                            <% if (existingOrder.status.toLowerCase()==='completed' ) {
                                                                %>
                                                                <p class="mb-0 mt-2">This order has been successfully
                                                                    processed
                                                                    and
                                                                    cannot be modified.</p>
                                                                <% } else if
                                                                    (existingOrder.status.toLowerCase()==='processing' )
                                                                    { %>
                                                                    <p class="mb-0 mt-2">This order is currently being
                                                                        processed
                                                                        and
                                                                        cannot be modified.</p>
                                                                    <% } else { %>
                                                                        <p class="mb-0 mt-2">This order is in <%=
                                                                                existingOrder.status.toLowerCase() %>
                                                                                status and
                                                                                cannot
                                                                                be modified.</p>
                                                                        <% } %>
                                                        </div>

                                                        <!-- Action Buttons -->
                                                        <div class="d-flex gap-2 flex-wrap">
                                                            <!-- Invoice button - only show for completed orders with vouchers -->
                                                            <% if (existingOrder.status.toLowerCase()==='completed' &&
                                                                existingOrder.voucherDetails &&
                                                                existingOrder.voucherDetails.length>
                                                                0) { %>
                                                                <% const
                                                                    successfulCount=existingOrder.voucherDetails.filter(detail=>
                                                                    detail.operation_succeeded === true).length;
                                                                    %>
                                                                    <% if (successfulCount> 0) { %>
                                                                        <a href="/store/<%= storeId %>/purchase-order/<%= existingOrder.id %>/invoice"
                                                                            class="btn btn-success">
                                                                            <i class="fas fa-file-invoice me-2"></i>View
                                                                            Invoice
                                                                        </a>
                                                                        <% } %>
                                                                            <% } %> <a
                                                                                    href="/store/<%= storeId %>/purchase-orders"
                                                                                    class="btn btn-secondary">
                                                                                    <i
                                                                                        class="fas fa-arrow-left me-2"></i>Back
                                                                                    to
                                                                                    Purchase
                                                                                    Orders
                                                                                </a>
                                                        </div>
                                                        <% } else { %>
                                                            <!-- Editable mode for draft/pending orders -->
                                                            <button type="button" class="btn btn-success me-2"
                                                                id="confirm-order-btn">
                                                                Confirm Order
                                                            </button>
                                                            <% if (existingOrder.status.toLowerCase()==='draft' ) { %>
                                                                <!-- Delete button - only for draft orders -->
                                                                <button type="button"
                                                                    class="btn btn-outline-danger me-2"
                                                                    onclick="deletePurchaseOrder('<%= existingOrder.id %>', '<%= existingOrder.purchase_order_number %>')">
                                                                    <i class="fas fa-trash me-2"></i>Delete Order
                                                                </button>
                                                                <% } %>
                                                                    <% } %>
                                                                        <% } else { %>
                                                                            <!-- New order mode -->
                                                                            <button type="button"
                                                                                class="btn btn-success me-2"
                                                                                id="confirm-order-btn">
                                                                                Confirm Order
                                                                            </button>
                                                                            <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body">
                                                <table class="table table-borderless">
                                                    <tr>
                                                        <td><strong>Total Items:</strong></td>
                                                        <td class="text-end" id="total-items">0</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Total Quantity:</strong></td>
                                                        <td class="text-end" id="total-vouchers">0</td>
                                                    </tr>
                                                    <tr class="border-top">
                                                        <td><strong>Total Cost:</strong></td>
                                                        <td class="text-end fs-5" id="summary-total-cost">$0.00</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    </div>

                    <!-- Navigation Actions -->
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>
                                            <a href="/store/<%= storeId %>/purchase-orders"
                                                class="btn btn-outline-primary">
                                                <i class="fas fa-list me-2"></i>All Purchase Orders
                                            </a>
                                            <a href="/clients/stock/<%= storeId %>" class="btn btn-outline-secondary">
                                                <i class="fas fa-cubes me-2"></i>Back to Stock Management
                                            </a>
                                        </div>
                                        <div>
                                            <% if (typeof user !=='undefined' && user && user.isSuperadmin) { %>
                                                <a href="/clients" class="btn btn-outline-info">
                                                    <i class="fas fa-store me-2"></i>All Stores
                                                </a>
                                                <% } else { %>
                                                    <a href="/" class="btn btn-outline-info">
                                                        <i class="fas fa-home me-2"></i>Dashboard
                                                    </a>
                                                    <% } %>
                                                        <% if (typeof existingOrder !=='undefined' && existingOrder &&
                                                            existingOrder.status==='COMPLETED' ) { %>
                                                            <% const successfulVouchers=existingOrder.voucherDetails ?
                                                                existingOrder.voucherDetails.filter(d=>
                                                                d.operation_succeeded
                                                                === true) : []; %>
                                                                <% if (successfulVouchers.length> 0) { %>
                                                                    <a href="/store/<%= storeId %>/purchase-order/<%= existingOrder.id %>/invoice"
                                                                        class="btn btn-success">
                                                                        <i class="fas fa-file-invoice me-2"></i>Generate
                                                                        Invoice
                                                                    </a>
                                                                    <% } %>
                                                                        <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Modal for Order Confirmation -->
                <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel"
                    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="progressModalLabel">
                                    <i class="fas fa-shopping-cart me-2"></i>Confirming Purchase Order
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span id="progress-text">Preparing order...</span>
                                        <span id="progress-percentage">0%</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                            role="progressbar" style="width: 0%" id="progress-bar">
                                        </div>
                                    </div>
                                </div>
                                <div class="small text-muted" id="progress-details">
                                    Initializing order confirmation process...
                                </div>
                            </div>
                            <div class="modal-footer d-none" id="progress-footer">
                                <button type="button" class="btn btn-secondary" id="close-progress"
                                    data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete purchase order <strong id="orderNumber"></strong>?
                                </p>
                                <p class="text-danger">This action cannot be undone.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDelete">Yes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast container for notifications -->
                <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container"></div>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <script src="/js/toast-utils.js"></script>
                <script src="/js/bootstrap-init.js"></script>
                <script src="/js/purchase-create-utils.js"></script>
                <script src="/js/purchase-order.js"></script>
</body>

</html>