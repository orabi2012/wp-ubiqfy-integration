<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <link href="/css/edit-page.css" rel="stylesheet">
    <link href="/css/modern-nav.css" rel="stylesheet">
    <link href="/css/navbar.css" rel="stylesheet">
    <link href="/css/clients.css" rel="stylesheet">
</head>

<% const sandboxClass=((typeof store !=='undefined' && store && store.ubiqfy_sandbox===true) || (typeof
    sandboxEnvironment !=='undefined' && sandboxEnvironment===true)) ? 'sandbox-environment' : '' ; %>

    <body class="form-page-body <%= sandboxClass %>">
        <% const pageTitle="Stock Management" %>
            <%- include('../shared/navbar') %>

                <div class="container-fluid mt-2 px-3">
                    <div class="row">
                        <div class="col-12">
                            <!-- Store Header -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1">
                                                <i class="fas fa-boxes"></i> Stock Management
                                            </h4>
                                            <p class="text-muted mb-0">
                                                Manage inventory levels for <strong>
                                                    <%= store.wp_store_name %>
                                                </strong>
                                            </p>
                                            <!-- Auto-refresh indicator (will be hidden by JavaScript after refresh) -->
                                            <div id="auto-refresh-indicator" class="mt-2">
                                                <small class="text-info">
                                                    <i class="fas fa-sync-alt fa-spin me-1"></i>
                                                    Auto-refreshing stock levels from wp...
                                                </small>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span
                                                class="badge <%= store.is_active ? 'status-active' : 'status-inactive' %> mb-2">
                                                <%= store.is_active ? 'Active' : 'Inactive' %>
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                <%= syncedOptions.length %> synced products
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modern Navigation Bar -->
                            <div class="card mb-3">
                                <div class="card-body p-0">
                                    <nav class="nav nav-pills nav-fill modern-nav">
                                        <a href="/clients/edit/<%= store.id %>"
                                            class="nav-link text-white d-flex align-items-center justify-content-center py-3"
                                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                                            title="Configure store settings, API credentials, and general options">
                                            <i class="fas fa-cogs fa-lg me-2"></i>
                                            <span class="fw-semibold">Store Settings</span>
                                        </a>
                                        <a href="/clients/sync/<%= store.id %>"
                                            class="nav-link text-white d-flex align-items-center justify-content-center py-3"
                                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                                            title="Fetch products from Ubiqfy and sync them to your wp store">
                                            <i class="fas fa-sync-alt fa-lg me-2"></i>
                                            <span class="fw-semibold">Sync Management</span>
                                        </a>
                                        <a href="/clients/stock/<%= store.id %>"
                                            class="nav-link text-white d-flex align-items-center justify-content-center py-3 active"
                                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                                            title="Manage stock levels and purchase codes for synced products">
                                            <i class="fas fa-cubes fa-lg me-2"></i>
                                            <span class="fw-semibold">Stock Management</span>
                                        </a>
                                        <a href="/store/<%= store.id %>/purchase-orders"
                                            class="nav-link text-white d-flex align-items-center justify-content-center py-3"
                                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                                            title="View and manage purchase orders for this store">
                                            <i class="fas fa-shopping-cart fa-lg me-2"></i>
                                            <span class="fw-semibold">Purchase Orders</span>
                                        </a>
                                        <% if (user.isSuperadmin) { %>
                                            <a href="/admin/dashboard"
                                                class="nav-link text-white d-flex align-items-center justify-content-center py-3"
                                                data-bs-toggle="tooltip" data-bs-placement="bottom"
                                                title="Return to admin dashboard">
                                                <i class="fas fa-arrow-left fa-lg me-2"></i>
                                                <span class="fw-semibold">Back to Dashboard</span>
                                            </a>
                                            <% } %>
                                    </nav>
                                </div>
                            </div>

                            <!-- Stock Management Table -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-inventory"></i> Synced Products Stock
                                    </h5>
                                    <div>
                                        <button class="btn btn-warning btn-sm me-2" onclick="saveAllStockLevels()">
                                            <i class="fas fa-save"></i> Save Min Stock Levels
                                        </button>
                                        <button class="btn btn-primary btn-sm me-2" onclick="refreshAllStock()">
                                            <i class="fas fa-sync-alt"></i> Refresh All Stock
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="createPurchaseOrder()"
                                            id="create-purchase-btn">
                                            <i class="fas fa-shopping-cart"></i> Create Purchase Order
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <% if (syncedOptions.length===0) { %>
                                        <div class="text-center py-5">
                                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                            <h4 class="text-muted">No Synced Products Found</h4>
                                            <p class="text-muted">Sync some products to wp first to manage their
                                                stock
                                                levels.
                                            </p>
                                            <a href="/clients/edit/<%= store.id %>" class="btn btn-primary">
                                                <i class="fas fa-sync"></i> Go to Product Management
                                            </a>
                                        </div>
                                        <% } else { %>
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Option Code</th>
                                                            <th>wp Product ID</th>
                                                            <th title="Minimum stock level to maintain. Set to 0 for no minimum threshold."
                                                                data-bs-toggle="tooltip">
                                                                Min Stock Level
                                                                <i class="fas fa-question-circle ms-1"
                                                                    style="font-size: 0.8em;"></i>
                                                            </th>
                                                            <th>wp Current Stock</th>
                                                            <th title="Quantity needed to purchase (Min Stock Level - Current Stock)"
                                                                data-bs-toggle="tooltip">
                                                                Qty
                                                                <i class="fas fa-question-circle ms-1"
                                                                    style="font-size: 0.8em;"></i>
                                                            </th>
                                                            <th title="Minimum face value for purchases from Ubiqfy"
                                                                data-bs-toggle="tooltip">
                                                                Min Face Value
                                                                <i class="fas fa-question-circle ms-1"
                                                                    style="font-size: 0.8em;"></i>
                                                            </th>
                                                            <th>Product Country</th>
                                                            <th>Cost Price (USD)</th>
                                                            <th>Last Synced</th>
                                                            <th title="Select products to include in purchase order"
                                                                data-bs-toggle="tooltip">
                                                                <div class="d-flex align-items-center">
                                                                    <input type="checkbox" class="form-check-input me-2"
                                                                        id="select-all"
                                                                        onchange="selectAllProducts(this)">
                                                                    <span>Select</span>
                                                                </div>
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% syncedOptions.forEach(option=> { %>
                                                            <tr id="row-<%= option.id %>">
                                                                <td>
                                                                    <strong>
                                                                        <%= option.product_name %>
                                                                    </strong>
                                                                    <br>
                                                                    <small class="text-muted">
                                                                        Code: <%= option.product_code %>
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <code><%= option.option_code %></code>
                                                                    <% if (option.option_name) { %>
                                                                        <br>
                                                                        <small class="text-muted">
                                                                            <%= option.option_name %>
                                                                        </small>
                                                                        <% } %>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        <%= option.wp_product_id %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <div class="input-group input-group-sm"
                                                                        style="max-width: 100px;">
                                                                        <input type="number" class="form-control"
                                                                            value="<%= option.stock_level %>" min="0"
                                                                            required id="stock-level-<%= option.id %>"
                                                                            onchange="updateStockLevel('<%= option.id %>', this.value)"
                                                                            title="Minimum stock level (0 = no minimum, 1+ = threshold)">
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <span id="wp-stock-<%= option.id %>"
                                                                            class="me-2">
                                                                            <span
                                                                                class="badge <%= option.wp_stock > 0 ? 'bg-primary' : 'bg-secondary' %>">
                                                                                <%= option.wp_stock %>
                                                                            </span>
                                                                        </span>
                                                                        <button class="btn btn-outline-primary btn-sm"
                                                                            onclick="refreshSingleStock('<%= option.id %>', '<%= option.wp_product_id %>')">
                                                                            <i class="fas fa-sync-alt"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span id="qty-to-purchase-<%= option.id %>">
                                                                        <%= Math.max(0, option.stock_level -
                                                                            option.wp_stock) %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span id="min-face-value-<%= option.id %>">
                                                                        <% if (option.min_face_value !==null &&
                                                                            option.min_face_value !==undefined) { %>
                                                                            <%= option.product_currency_code || 'USD' %>
                                                                                <%= parseFloat(option.min_face_value).toFixed(2)
                                                                                    %>
                                                                                    <% } else { %>
                                                                                        <span class="text-muted">Not
                                                                                            set</span>
                                                                                        <% } %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <% if (option.country_iso) { %>
                                                                        <span class="badge bg-info">
                                                                            <%= option.country_iso %>
                                                                        </span>
                                                                        <% } else { %>
                                                                            <span class="text-muted">Unknown</span>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    $<%= parseFloat(option.wholesale_price_usd ||
                                                                        option.original_price_usd).toFixed(4) %>
                                                                        <% if (option.custom_price) { %>
                                                                            <br>
                                                                            <small class="text-success">
                                                                                Custom: <%= store.wp_currency %>
                                                                                    <%= parseFloat(option.custom_price).toFixed(4)
                                                                                        %>
                                                                                        %>
                                                                            </small>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    <% if (option.last_synced_at) { %>
                                                                        <small>
                                                                            <%= new
                                                                                Date(option.last_synced_at).toLocaleDateString()
                                                                                %>
                                                                                <br>
                                                                                <%= new
                                                                                    Date(option.last_synced_at).toLocaleTimeString()
                                                                                    %>
                                                                        </small>
                                                                        <% } else { %>
                                                                            <span class="text-muted">Never</span>
                                                                            <% } %>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <input type="checkbox"
                                                                            class="form-check-input me-2"
                                                                            id="select-<%= option.id %>"
                                                                            data-option-id="<%= option.id %>"
                                                                            data-product-code="<%= option.product_code %>"
                                                                            data-option-code="<%= option.option_code %>"
                                                                            data-actual-product-name="<%= option.product_name %>"
                                                                            data-provider-code="<%= option.provider_code || 'Unknown' %>"
                                                                            data-product-name="<%= (option.option_name || option.product_name) + ' (' + (option.country_iso || 'N/A') + ')' %>"
                                                                            data-option-name="<%= (option.option_name || '') + ' (' + (option.country_iso || 'N/A') + ')' %>"
                                                                            data-face-value="<%= option.min_face_value || 0 %>"
                                                                            data-wholesale-price="<%= parseFloat(option.wholesale_price_usd || option.original_price_usd || 0) %>"
                                                                            data-qty-needed="<%= Math.max(0, option.stock_level - option.wp_stock) %>"
                                                                            onchange="updateCreateButtonState()">
                                                                        <label for="select-<%= option.id %>"
                                                                            class="form-check-label">
                                                                        </label>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <% } %>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between mt-3 mb-4">
                                <a href="/clients/edit/<%= store.id %>" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Store Edit
                                </a>
                                <% if (user.isSuperadmin) { %>
                                    <a href="/clients" class="btn btn-outline-primary">
                                        <i class="fas fa-list"></i> Back to Stores List
                                    </a>
                                    <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Modal for Purchase Order Creation -->
                <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel"
                    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="progressModalLabel">
                                    <i class="fas fa-shopping-cart me-2"></i>Creating Purchase Order
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span id="progress-text">Preparing order...</span>
                                        <span id="progress-percentage">0%</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                            role="progressbar" style="width: 0%" id="progress-bar">
                                        </div>
                                    </div>
                                </div>
                                <div class="small text-muted" id="progress-details">
                                    Collecting selected products...
                                </div>
                            </div>
                            <div class="modal-footer d-none" id="progress-footer">
                                <button type="button" class="btn btn-secondary" id="close-progress"
                                    data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Refresh Progress Modal -->
                <div class="modal fade" id="stockProgressModal" tabindex="-1" aria-labelledby="stockProgressModalLabel"
                    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="stockProgressModalLabel">
                                    <i class="fas fa-sync-alt me-2"></i>Refreshing Stock Levels
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span id="stock-progress-text">Initializing...</span>
                                        <span id="stock-progress-percentage">0%</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                            role="progressbar" style="width: 0%" id="stock-progress-bar">
                                        </div>
                                    </div>
                                </div>
                                <div class="small text-muted" id="stock-progress-details">
                                    Preparing to refresh stock levels from wp...
                                </div>
                            </div>
                            <div class="modal-footer d-none" id="stock-progress-footer">
                                <button type="button" class="btn btn-secondary" id="close-stock-progress"
                                    data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bootstrap JS -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <script src="/js/bootstrap-init.js"></script>

                <!-- Page Data for JavaScript -->
                <script type="application/json" id="page-data">
        {
            "storeId": "<%= store.id %>",
            "userId": "<%= user.userId %>",
            "username": "<%= user.username %>",
            "isSuperadmin": <%= user.isSuperadmin %>
        }
    </script>

                <!-- External JavaScript Files -->
                <script src="/js/common.js"></script>
                <script src="/js/stock-page.js"></script>
    </body>

</html>